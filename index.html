<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ATS Resume Builder Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 24px;
      max-width: 900px;
      margin: auto;
      background: #fafafa;
    }
    input, textarea, button, select {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      font-size: 14px;
    }
    button { cursor: pointer; }
    .box {
      background: #fff;
      padding: 16px;
      margin-top: 24px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .tag {
      display: inline-block;
      padding: 6px 10px;
      margin: 4px;
      border-radius: 4px;
      font-size: 13px;
    }
    .matched { background: #d4f8d4; }
    .missing { background: #ffd6d6; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<h2>ATS Resume Builder</h2>

<input id="name" placeholder="Name" />
<input id="role" placeholder="Target Role" />
<textarea id="summary" placeholder="Professional Summary"></textarea>
<button onclick="rewriteSummary()">âœ¨ Rewrite Summary (AI)</button>
<textarea id="jd" placeholder="Job Description"></textarea>
<textarea id="experience" placeholder="Experience"></textarea>
<input id="skills" placeholder="Skills (comma separated)" />

<button onclick="saveResume()">Save Resume</button>
<button onclick="downloadPDF()">Download Resume (PDF)</button>

<!-- âœ… CURRENT PLAN (ALWAYS VISIBLE) -->
<div class="box">
  <h3>Current Plan</h3>
  <p><b>Plan:</b> <span id="plan"></span></p>
  <p><b>Plan Expiry:</b> <span id="expiry"></span></p>
  <p><b>AI Rewrites Left:</b> <span id="aiLeft"></span></p>
</div>

<!-- INSIGHTS (RESUME DEPENDENT) -->
<div id="insights" class="box" style="display:none">
  <h3>Resume Insights</h3>

  <p><b>ATS Score:</b> <span id="atsScore"></span></p>
  <p><b>JD Match %:</b> <span id="jdMatch"></span></p>
  <p><b>Resume Completeness:</b> <span id="completeness"></span></p>
  <p><b>Last Saved:</b> <span id="lastSaved"></span></p>

  <h4>Matched Keywords</h4>
  <div id="matchedKeywords"></div>

  <h4>Missing Keywords</h4>
  <div id="missingKeywords"></div>
</div>

<!-- UPGRADE -->
<div class="box">
  <h3>Upgrade Plan</h3>
  <select id="upgradeSelect">
    <option value="49">â‚¹49 â€“ One Time</option>
    <option value="99">â‚¹99 â€“ 1 Week</option>
    <option value="149">â‚¹149 â€“ 15 Days</option>
    <option value="299">â‚¹299 â€“ 1 Month</option>
    <option value="699">â‚¹699 â€“ 3 Months</option>
    <option value="999">â‚¹999 â€“ 6 Months</option>
    <option value="1699">â‚¹1699 â€“ 1 Year</option>
  </select>
  <button onclick="upgradePlan()">Upgrade</button>
</div>

<script>
const PLANS = {
  49:  { name: "One-Time", days: 1, ai: 3 },
  99:  { name: "Weekly", days: 7, ai: 10 },
  149: { name: "15 Days", days: 15, ai: 25 },
  299: { name: "Monthly", days: 30, ai: 50 },
  699: { name: "3 Months", days: 90, ai: 120 },
  999: { name: "6 Months", days: 180, ai: 250 },
  1699:{ name: "Yearly", days: 365, ai: 999 }
};

if (!localStorage.getItem("plan")) {
  localStorage.setItem("plan", JSON.stringify({
    price: 49,
    name: "One-Time",
    expiry: null,
    aiLeft: 3
  }));
}

/* âœ… PLAN RENDER (GLOBAL, SAFE) */
function renderPlan() {
  const p = JSON.parse(localStorage.getItem("plan"));
  if (!p) return;

  plan.textContent = `â‚¹${p.price} (${p.name})`;
  expiry.textContent = p.expiry
    ? new Date(p.expiry).toLocaleDateString()
    : "One-time (no expiry)";
  aiLeft.textContent = p.aiLeft;
}

function saveResume() {
  const data = {
    name: name.value,
    role: role.value,
    summary: summary.value,
    jd: jd.value,
    experience: experience.value,
    skills: skills.value,
    savedAt: new Date().toLocaleString()
  };
  localStorage.setItem("resume", JSON.stringify(data));
  calculateATS(data);
}

function calculateATS(data) {
  const jdWords = data.jd.toLowerCase().split(/\W+/).filter(w => w.length > 3);
  const resumeText = (data.summary + data.experience + data.skills).toLowerCase();
  const unique = [...new Set(jdWords)];

  const matched = unique.filter(w => resumeText.includes(w));
  const missing = unique.filter(w => !resumeText.includes(w));

  const jdMatch = unique.length ? Math.round((matched.length / unique.length) * 100) : 0;
  const atsScore = Math.min(100, jdMatch + 10);

  const completeness = Math.round(
    [data.name, data.role, data.summary, data.jd, data.experience, data.skills]
      .filter(v => v && v.trim()).length / 6 * 100
  );

  const result = { atsScore, jdMatch, completeness, matched, missing, savedAt: data.savedAt };
  localStorage.setItem("atsResult", JSON.stringify(result));
  render(result);
}

function render(r) {
  insights.style.display = "block";
  atsScore.textContent = r.atsScore + "%";
  jdMatch.textContent = r.jdMatch + "%";
  completeness.textContent = r.completeness + "%";
  lastSaved.textContent = r.savedAt;

  matchedKeywords.innerHTML = r.matched.map(k => `<span class="tag matched">${k}</span>`).join("");
  missingKeywords.innerHTML = r.missing.map(k => `<span class="tag missing">${k}</span>`).join("");
}

function rewriteSummary() {
  const p = JSON.parse(localStorage.getItem("plan"));
  if (p.aiLeft <= 0) return alert("AI limit exhausted. Upgrade plan.");

  p.aiLeft--;
  localStorage.setItem("plan", JSON.stringify(p));

  summary.value = `ATS-optimized ${role.value} professional aligned with job requirements.`;
  renderPlan();
}

function upgradePlan() {
  const price = upgradeSelect.value;
  const plan = PLANS[price];
  const expiry = plan.days ? Date.now() + plan.days * 86400000 : null;

  localStorage.setItem("plan", JSON.stringify({
    price,
    name: plan.name,
    expiry,
    aiLeft: plan.ai
  }));

  alert("Plan upgraded successfully!");
  renderPlan();
}

/* ðŸ” RESTORE ON LOAD */
(function restore() {
  const resume = JSON.parse(localStorage.getItem("resume"));
  const ats = JSON.parse(localStorage.getItem("atsResult"));

  if (resume) {
    name.value = resume.name || "";
    role.value = resume.role || "";
    summary.value = resume.summary || "";
    jd.value = resume.jd || "";
    experience.value = resume.experience || "";
    skills.value = resume.skills || "";
  }

  renderPlan();
  if (ats) render(ats);
})();

function downloadPDF() {
  if (!window.jspdf) {
    alert("PDF library not loaded");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const resume = JSON.parse(localStorage.getItem("resume"));
  if (!resume) {
    alert("Please save your resume first");
    return;
  }

  let y = 15;

  doc.setFontSize(16);
  doc.text(resume.name || "Name", 10, y);
  y += 8;

  doc.setFontSize(12);
  doc.text(`Target Role: ${resume.role || "-"}`, 10, y);
  y += 10;

  doc.setFontSize(13);
  doc.text("Summary", 10, y);
  y += 6;

  doc.setFontSize(11);
  doc.text(resume.summary || "-", 10, y, { maxWidth: 180 });
  y += 20;

  doc.setFontSize(13);
  doc.text("Experience", 10, y);
  y += 6;

  doc.setFontSize(11);
  doc.text(resume.experience || "-", 10, y, { maxWidth: 180 });
  y += 20;

  doc.setFontSize(13);
  doc.text("Skills", 10, y);
  y += 6;

  doc.setFontSize(11);
  doc.text(resume.skills || "-", 10, y, { maxWidth: 180 });

  doc.save("ResumeIQ.pdf");
}
</script>

</body>
</html>